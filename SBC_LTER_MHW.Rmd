---
title: "SBC_LTER_MHW"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# This markdown is to look at using the package heatwaveR on the SBC_LTER to see if I can identify marine heatwaves

#This particular data set is from nearshore locations along the Northern Channel Islands in the Santa Barbara Channel, its been on going since 2000. 

```{r}
library(ggplot2)
library(dplyr)
library(heatwaveR)
library(tidyverse)
```
### Bringing in the dataset and getting to know it
```{r}
nci_temp <- read.csv("Island_temp_hourly_allsites_allyears_20210218.csv")
```

```{r}
head(nci_temp)
unique(nci_temp$site)
#So we have 21 sites total. Probably going to want to split up the data into each site. 
#Notice that the temp is also recorded by the hour for each day, this doesn't work with the heatwavesR package fxn, therefore lets create a new column that takes the average of each day as the total record? 
```
### Wrangling and cleaning the data
```{r}
is.character(nci_temp$datetime_gmt) #Make sure the date is in character string data type 

nci_temp_sep <- nci_temp%>% 
  separate(datetime_gmt, c("date", "time"), " ") #We need to separate out the data so that times are separated from the data, note that open   " " denotes that the date and time are separated by a space in the column datetime_gmt
```

 
```{r}
#Next, it looks like we're going to need to specify a particular depth range: 14m and only keep these recordings. (14m has the long term values according to the metadata)
nci_temp_14m <- nci_temp_sep %>% 
  dplyr::filter(depth_m == 14)
```




```{r}
#Now lets find the mean temperature for every day and create a new column for it. 
nci_temp_14m_avgT <- nci_temp_14m %>% 
  group_by(date, site) %>% 
  mutate(mean_daily_temp_c = mean(temperature_c))

# Now lets do a sanity check 

(12.62 + 12.66258 + 12.71138)/3 #Nice, the code does what we want. 
```
```{r}
# Now that we have an avg for each day, lets get rid of all the duplicate days by using distinct()
nci_temp_14m_avgT_daily <- nci_temp_14m_avgT %>% 
  distinct(date, .keep_all = TRUE)

#And lets remove the time column since that's not really representative of anything at this point 

nci_temp_14m_avgT_daily <- select(nci_temp_14m_avgT_daily, -c(time, temperature_c))
```

```{r}

```

```{r}
#We can now divide by sites if we would like, lets try looking at the ANS site. 
nci_temp_ANS <- nci_temp_14m_avgT_daily %>% 
  dplyr::filter(site == "ANS")

#Changing the date column to the data type.
nci_temp_ANS <- nci_temp_ANS %>% 
  mutate(date = as.Date(date))

head(nci_temp_ANS)
```





```{r}
#Detect events in a time series
ANS_ts <- ts2clm(nci_temp_ANS, x = date, y = mean_daily_temp_c, climatologyPeriod = c("2003-04-11", "2020-09-18"))

ANS_mhw <- detect_event(ANS_ts, x = date, y = mean_daily_temp_c)
```

```{r}
ANS_mhw$event %>% 
  dplyr::ungroup() %>% 
  dplyr::select(event_no, duration, date_start, date_peak, intensity_max, intensity_cumulative) %>% 
  dplyr::arrange(-intensity_max) %>% 
  head(5)
```
```{r}
#Visualizing
event_line(ANS_mhw, spread = 180, metric = "intensity_max", 
           start_date = "2003-04-11", end_date = "2020-09-18")
```



### Data citation: Washburn, L, L. Kui. 2021. SBC LTER: Ocean: Ocean hourly temperature at nearshore locations along the Northern Channel Islands in the Santa Barbara Channel, ongoing since 2000 ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/1dfe35ec63376ba1f02172ab92f8032e. Accessed 2021-11-04.